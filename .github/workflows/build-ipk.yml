name: Build webOS IPK with Auto-Versioning and Release

on:
  push:
    branches: [ main ]

jobs:
  version-bump-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For tagging, committing, and releasing

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Automated Version Bump
        id: version-bump
        uses: phips28/gh-action-bump-version@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          target-file: 'appinfo.json'  # Adjust if in subfolder
          major-wording: 'BREAKING CHANGE,BREAKING CHANGES,major'
          minor-wording: 'feat,feature'
          patch-wording: 'fix,bugfix,chore,refactor'

      - name: Show new version
        run: echo "New version: ${{ steps.version-bump.outputs.newTag }}"

      - name: Install webOS CLI
        run: npm install @webos-tools/cli

      - name: Package into IPK
        run: npx ares-package .

      - name: Rename IPK with version
        id: rename-ipk
        run: |
          APP_ID=$(jq -r .id appinfo.json)
          VERSION=$(jq -r .version appinfo.json)
          OLD_IPK=$(ls *.ipk | head -n 1)
          NEW_IPK="${APP_ID}_${VERSION}_all.ipk"
          mv "$OLD_IPK" "$NEW_IPK"
          echo "ipk_file=$NEW_IPK" >> $GITHUB_OUTPUT

      - name: Create/Release and Upload IPK
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.version-bump.outputs.newTag }}
          artifacts: ${{ steps.rename-ipk.outputs.ipk_file }}
          allowUpdates: true  # Updates existing release if tag already exists
          generateReleaseNotes: true  # Optional: auto-generates notes from commits